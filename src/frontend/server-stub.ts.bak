/**
 * Express.js Frontend Server - Complete Port from Django
 * 
 * This server replaces the Django frontend with a modern Express.js/TypeScript implementation.
 * It provides all the same functionality: demo, replay, simulator, and persona state views.
 */

import express, { Request, Response } from 'express';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';
import { readFileSync, existsSync, readdirSync } from 'fs';
import { config } from '../config.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const app = express();
const port = config.server.frontendPort;

// Configure EJS as template engine
app.set('view engine', 'ejs');
app.set('views', join(__dirname, 'views'));

// Middleware
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// Serve static files from multiple directories
app.use('/static', express.static(join(process.cwd(), 'environment/frontend_server/static_dirs')));
app.use('/js', express.static(join(__dirname, 'public/js')));
app.use('/css', express.static(join(__dirname, 'public/css')));

// ============================================================================
// UTILITY FUNCTIONS (from Django's global_methods.py)
// ============================================================================

/**
 * Load JSON file safely
 */
function loadJSON(filePath: string): any {
  try {
    if (!existsSync(filePath)) {
      return null;
    }
    const content = readFileSync(filePath, 'utf-8');
    return JSON.parse(content);
  } catch (error) {
    console.error(`Error loading JSON from ${filePath}:`, error);
    return null;
  }
}

/**
 * Format date for display
 */
function formatDateTime(date: Date): string {
  return date.toLocaleString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
}

// ============================================================================
// ROUTES
// ============================================================================

/**
 * Landing page
 */
app.get('/', (_req: Request, res: Response) => {
  res.send(`
    <!DOCTYPE html>
    <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Generative Agents - Interactive Simulacra</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <style>
          body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          .container {
            max-width: 900px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 50px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
          }
          h1 {
            font-size: 3em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
          }
          .status-box {
            background: rgba(76, 175, 80, 0.3);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #4CAF50;
            margin: 30px 0;
          }
          .info-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
          }
          .btn-custom {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            text-decoration: none;
            display: inline-block;
            margin: 10px 5px;
            transition: all 0.3s;
          }
          .btn-custom:hover {
            background: white;
            color: #667eea;
            transform: translateY(-2px);
          }
          code {
            background: rgba(0, 0, 0, 0.3);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
          }
          ul {
            text-align: left;
          }
        </style>
      </head>
      <body>
        <div class="container text-center">
          <h1>üéÆ Generative Agents</h1>
          <h3>Interactive Simulacra of Human Behavior</h3>
          
          <div class="status-box">
            <strong>‚úÖ Environment server is up and running!</strong>
          </div>
          
          <div class="info-box">
            <h4><strong>Server Information</strong></h4>
            <p><strong>Type:</strong> Express.js (TypeScript/Node.js)</p>
            <p><strong>Port:</strong> ${port}</p>
            <p><strong>Backend:</strong> OpenRouter API with multiple model support</p>
            <p><strong>Status:</strong> Ready to simulate</p>
          </div>

          <div class="info-box text-start">
            <h4><strong>Available Simulations</strong></h4>
            <ul>
              <li><a href="/demo/July1_the_ville_isabella_maria_klaus-step-3-20/1/3" class="text-white">Demo: Isabella, Maria & Klaus</a></li>
              <li><a href="/replay/July1_the_ville_isabella_maria_klaus-step-3-20/1" class="text-white">Replay: Isabella, Maria & Klaus</a></li>
              <li><a href="/simulator_home" class="text-white">Simulator Home</a></li>
            </ul>
          </div>

          <div class="mt-4">
            <a href="/simulator_home" class="btn-custom">Start Simulation</a>
            <a href="/demo/July1_the_ville_isabella_maria_klaus-step-3-20/1/3" class="btn-custom">View Demo</a>
          </div>

          <div class="info-box text-start mt-4">
            <h4><strong>Quick Start</strong></h4>
            <ul>
              <li>Start backend: <code>npm run start</code></li>
              <li>View pre-computed demos: <code>/demo/&lt;sim-name&gt;/&lt;step&gt;/&lt;speed&gt;</code></li>
              <li>Replay simulations: <code>/replay/&lt;sim-name&gt;/&lt;step&gt;</code></li>
              <li>Run live simulation: <code>/simulator_home</code></li>
            </ul>
          </div>

          <p class="mt-4">
            <small>Based on the paper: <a href="https://arxiv.org/abs/2304.03442" class="text-white"><u>Generative Agents: Interactive Simulacra of Human Behavior</u></a></small>
          </p>
        </div>
      </body>
    </html>
  `);
});

/**
 * Demo page - Pre-computed replay of a simulation
 * Port of Django's demo() view
 */
app.get('/demo/:simCode/:step/:playSpeed?', (req: Request, res: Response) => {
  const { simCode, step: stepStr, playSpeed: playSpeedStr } = req.params;
  const step = parseInt(stepStr);
  
  const moveFile = `compressed_storage/${simCode}/master_movement.json`;
  const metaFile = `compressed_storage/${simCode}/meta.json`;
  
  const playSpeedOpt: { [key: string]: number } = {
    '1': 1, '2': 2, '3': 4, '4': 8, '5': 16, '6': 32
  };
  
  let playSpeed = 2;
  if (playSpeedStr && playSpeedStr in playSpeedOpt) {
    playSpeed = playSpeedOpt[playSpeedStr];
  }
  
  // Load meta information
  const meta = loadJSON(metaFile);
  if (!meta) {
    return res.status(404).send('Simulation not found');
  }
  
  const secPerStep = meta.sec_per_step;
  let startDatetime = new Date(meta.start_date + ' 00:00:00');
  
  // Add time for each step
  for (let i = 0; i < step; i++) {
    startDatetime = new Date(startDatetime.getTime() + secPerStep * 1000);
  }
  
  const startDatetimeISO = startDatetime.toISOString().slice(0, 19);
  
  // Load movement file
  const rawAllMovement = loadJSON(moveFile);
  if (!rawAllMovement) {
    return res.status(404).send('Movement data not found');
  }
  
  // Get persona names
  const personaNames: Array<{ original: string; underscore: string; initial: string }> = [];
  const personaNamesSet = new Set<string>();
  
  if (rawAllMovement['0']) {
    for (const p of Object.keys(rawAllMovement['0'])) {
      const nameParts = p.split(' ');
      personaNames.push({
        original: p,
        underscore: p.replace(/ /g, '_'),
        initial: p[0] + nameParts[nameParts.length - 1][0]
      });
      personaNamesSet.add(p);
    }
  }
  
  // Prepare initial positions
  const initPrep: { [key: string]: any } = {};
  for (let intKey = 0; intKey <= step; intKey++) {
    const key = intKey.toString();
    const val = rawAllMovement[key];
    if (val) {
      for (const p of personaNamesSet) {
        if (p in val) {
          initPrep[p] = val[p];
        }
      }
    }
  }
  
  const personaInitPos: { [key: string]: any } = {};
  for (const p of personaNamesSet) {
    if (initPrep[p]) {
      personaInitPos[p.replace(/ /g, '_')] = initPrep[p].movement;
    }
  }
  
  // Prepare all movement
  const allMovement: { [key: number]: any } = {};
  allMovement[step] = initPrep;
  
  for (let intKey = step + 1; intKey < Object.keys(rawAllMovement).length; intKey++) {
    allMovement[intKey] = rawAllMovement[intKey.toString()];
  }
  
  // Render template
  res.render('demo', {
    simCode,
    step,
    personaNames,
    personaInitPos: JSON.stringify(personaInitPos),
    allMovement: JSON.stringify(allMovement),
    startDatetime: startDatetimeISO,
    secPerStep,
    playSpeed,
    mode: 'demo'
  });
});

/**
 * Replay page - Replay of a previous simulation
 * Port of Django's replay() view
 */
app.get('/replay/:simCode/:step', (req: Request, res: Response) => {
  const { simCode, step: stepStr } = req.params;
  const step = parseInt(stepStr);
  
  const moveFile = `storage/${simCode}/movement/${step}.json`;
  const metaFile = `storage/${simCode}/meta.json`;
  
  const meta = loadJSON(metaFile);
  if (!meta) {
    return res.status(404).send('Simulation not found');
  }
  
  // Similar logic to demo but reads from storage instead of compressed_storage
  // For now, render a simplified version
  res.render('replay', {
    simCode,
    step,
    message: 'Replay functionality - loads from storage directory'
  });
});

/**
 * Simulator home - Live simulation interface
 * Port of Django's simulator_home() view
 */
app.get('/simulator_home', (_req: Request, res: Response) => {
  res.render('simulator_home', {
    title: 'Smallville Simulator',
    message: 'Interactive simulation interface'
  });
});

/**
 * Persona state - Detailed agent state view
 * Port of Django's replay_persona_state() view
 */
app.get('/replay_persona_state/:simCode/:step/:personaName', (req: Request, res: Response) => {
  const { simCode, step, personaName } = req.params;
  
  res.render('persona_state', {
    simCode,
    step,
    personaName: personaName.replace(/_/g, ' '),
    message: 'Persona state details'
  });
});

/**
 * List available simulations
 */
app.get('/simulations/list', (_req: Request, res: Response) => {
  try {
    const compressedDir = 'compressed_storage';
    const storageDir = 'storage';
    
    const compressed = existsSync(compressedDir) ? readdirSync(compressedDir) : [];
    const storage = existsSync(storageDir) ? readdirSync(storageDir) : [];
    
    res.json({
      compressed: compressed.filter(f => !f.startsWith('.')),
      storage: storage.filter(f => !f.startsWith('.'))
    });
  } catch (error) {
    res.status(500).json({ error: 'Failed to list simulations' });
  }
});

/**
 * API endpoint for simulation status
 */
app.get('/api/simulation/status', (_req: Request, res: Response) => {
  res.json({
    status: 'ready',
    backend: 'openrouter',
    port: config.server.backendPort,
    frontend: port
  });
});

// ============================================================================
// ERROR HANDLING
// ============================================================================

app.use((_req: Request, res: Response) => {
  res.status(404).send(`
    <!DOCTYPE html>
    <html>
      <head>
        <title>404 - Not Found</title>
        <style>
          body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: #1a1a1a;
            color: white;
          }
          h1 { color: #ff6b6b; }
        </style>
      </head>
      <body>
        <h1>404 - Page Not Found</h1>
        <p>The page you're looking for doesn't exist.</p>
        <p><a href="/" style="color: #4CAF50">Go back to home</a></p>
      </body>
    </html>
  `);
});

// ============================================================================
// START SERVER
// ============================================================================

app.listen(port, () => {
  console.log('');
  console.log('üöÄ ========================================');
  console.log('üöÄ Generative Agents Frontend Server');
  console.log('üöÄ ========================================');
  console.log(`üåê Server: http://localhost:${port}`);
  console.log(`üéÆ Simulator: http://localhost:${port}/simulator_home`);
  console.log(`üé¨ Demo: http://localhost:${port}/demo/July1_the_ville_isabella_maria_klaus-step-3-20/1/3`);
  console.log('üöÄ ========================================');
  console.log('');
});

export default app;
